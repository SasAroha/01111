<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>未来の収支サマリー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 font-sans">
  <div class="max-w-2xl mx-auto bg-white shadow-xl rounded-2xl p-6 space-y-6">
    <div class="mb-4 text-right">
      <a href="index.html" class="inline-block bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">家計簿に戻る</a>
    </div>
    <h1 class="text-2xl font-bold text-green-700 mb-4">未来の収支サマリー</h1>
    <div class="mb-8">
      <h2 class="text-xl font-bold text-green-700 mb-2">未来の収支入力</h2>
      <form id="future-form" class="grid grid-cols-1 gap-4">
        <div class="grid grid-cols-3 gap-2">
          <select id="future-year" class="p-2 border rounded"></select>
          <select id="future-month" class="p-2 border rounded"></select>
          <select id="future-day" class="p-2 border rounded"></select>
        </div>
        <div class="flex flex-col gap-1">
          <div class="flex gap-2 mb-1">
            <button type="button" id="future-type-minus" class="toggle-expense-type bg-red-500 text-white px-3 py-1 rounded font-bold">− 支出</button>
            <button type="button" id="future-type-plus" class="toggle-expense-type bg-gray-200 text-gray-700 px-3 py-1 rounded font-bold">＋ 収入</button>
          </div>
          <input type="number" id="future-amount" placeholder="金額（絶対値）" required class="p-2 border rounded" />
        </div>
        <input type="text" id="future-note" placeholder="内容のメモ" class="p-2 border rounded" />
        <input type="text" id="future-tags" placeholder="タグ（スペース区切り）" class="p-2 border rounded" />
        <button type="submit" class="bg-green-500 text-white py-2 rounded hover:bg-green-600">登録</button>
      </form>
      <div id="future-message" class="mt-2 text-sm"></div>
    </div>
    <!-- 未来収支合計サマリー -->
    <div id="total-summary" class="mb-4 p-4 bg-gray-50 rounded shadow flex flex-col sm:flex-row sm:items-center sm:justify-between text-lg font-semibold"></div>
    <div id="month-summary-scroll" class="overflow-x-auto">
      <div id="month-summary" class="flex gap-4 min-w-max"></div>
    </div>
    <div id="details" class="mt-8"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      query,
      orderBy,
      addDoc
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA2J4CITv2bfm0tE-faGnVY5eDK8fX9alM",
      authDomain: "project-6408152347446047081.firebaseapp.com",
      projectId: "project-6408152347446047081",
      storageBucket: "project-6408152347446047081.firebasestorage.app",
      messagingSenderId: "514480943049",
      appId: "1:514480943049:web:46645061f1225d214c8218",
      measurementId: "G-7M18GX9J8X"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 月ごとにグループ化する関数
    function groupByMonth(data) {
      const map = {};
      data.forEach(item => {
        const month = item.date ? item.date.slice(0,7) : ""; // "YYYY-MM"
        if (!map[month]) map[month] = [];
        map[month].push(item);
      });
      return map;
    }

    // 昇順（古い→新しい）で全月リストを返す
    function getAllMonths(data) {
      return Object.keys(data).sort();
    }

    // 月ごとの合計を計算
    function calcSummary(items) {
      let plus = 0, minus = 0;
      items.forEach(i => {
        if (i.amount > 0) plus += i.amount;
        else minus += i.amount;
      });
      return { plus, minus };
    }

    // 全体合計サマリー表示
    function renderTotalSummary(data) {
      let plus = 0, minus = 0;
      data.forEach(i => {
        if (i.amount > 0) plus += i.amount;
        else minus += i.amount;
      });
      const diff = plus + minus;
      const el = document.getElementById("total-summary");
      el.innerHTML = `<div>収入合計: <span class='text-green-700'>+${plus.toLocaleString()}円</span></div>
        <div>支出合計: <span class='text-red-600'>${minus.toLocaleString()}円</span></div>
        <div>差額: <span class='${diff >= 0 ? 'text-green-700' : 'text-red-600'}'>${diff.toLocaleString()}円</span></div>`;
    }

    // サマリー表示（横スクロール・無限ロード対応）
    let loadedMonthCount = 0;
    let allMonths = [];
    let monthMap = {};
    let allData = [];
    const MONTHS_PER_LOAD = 6;
    function renderMonthSummaryInfinite() {
      const summaryDiv = document.getElementById("month-summary");
      // すでに表示済みの数
      const start = loadedMonthCount;
      const end = Math.min(loadedMonthCount + MONTHS_PER_LOAD, allMonths.length);
      for (let i = start; i < end; i++) {
        const month = allMonths[i];
        const { plus, minus } = calcSummary(monthMap[month]);
        const diff = plus + minus;
        const btn = document.createElement("button");
        btn.className = "bg-green-100 hover:bg-green-200 rounded p-4 text-left shadow transition min-w-[180px] flex-shrink-0";
        btn.innerHTML = `<div class='font-bold text-lg mb-1'>${month}</div>
          <div class='flex justify-between'><span>収入</span><span class='text-green-700 font-semibold'>+${plus.toLocaleString()}円</span></div>
          <div class='flex justify-between'><span>支出</span><span class='text-red-600 font-semibold'>${minus.toLocaleString()}円</span></div>
          <div class='flex justify-between'><span>差額</span><span class='${diff >= 0 ? 'text-green-700' : 'text-red-600'} font-semibold'>${diff.toLocaleString()}円</span></div>`;
        btn.addEventListener("click", () => renderDetails(month, monthMap[month]));
        summaryDiv.appendChild(btn);
      }
      loadedMonthCount = end;
    }

    // 横スクロールで右端に到達したら追加ロード
    function setupInfiniteScroll() {
      const scrollDiv = document.getElementById("month-summary-scroll");
      scrollDiv.addEventListener("scroll", () => {
        if (scrollDiv.scrollLeft + scrollDiv.clientWidth >= scrollDiv.scrollWidth - 10) {
          renderMonthSummaryInfinite();
        }
      });
    }

    // 詳細表示
    function renderDetails(month, items) {
      const detailsDiv = document.getElementById("details");
      detailsDiv.innerHTML = `<h2 class='text-xl font-bold mb-2'>${month} の明細</h2>`;
      if (!items.length) {
        detailsDiv.innerHTML += '<div>データなし</div>';
        return;
      }
      const table = document.createElement("table");
      table.className = "w-full text-sm mt-2 table-auto";
      table.innerHTML = `<thead><tr>
        <th class='p-2'>日付</th><th class='p-2'>金額</th><th class='p-2'>メモ</th><th class='p-2'>タグ</th>
      </tr></thead><tbody></tbody>`;
      const tbody = table.querySelector("tbody");
      items.forEach(item => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class='p-2'>${item.date}</td>
          <td class='p-2 ${item.amount > 0 ? 'text-green-700' : 'text-red-600'}'>${item.amount.toLocaleString()}円</td>
          <td class='p-2'>${item.note || ''}</td>
          <td class='p-2'>${(item.tags||[]).join(' ')}</td>`;
        tbody.appendChild(tr);
      });
      detailsDiv.appendChild(table);
    }

    // Firestoreからデータ取得＆描画
    async function loadFutureExpenses() {
      const q = query(collection(db, "future_expenses"), orderBy("date", "asc"));
      const querySnapshot = await getDocs(q);
      const data = [];
      querySnapshot.forEach(docSnap => {
        data.push(docSnap.data());
      });
      allData = data;
      monthMap = groupByMonth(data);
      allMonths = getAllMonths(monthMap);
      loadedMonthCount = 0;
      // 合計サマリー
      renderTotalSummary(data);
      // 月サマリー
      document.getElementById("month-summary").innerHTML = "";
      renderMonthSummaryInfinite();
      // 最初の月を自動表示
      if (allMonths.length) renderDetails(allMonths[0], monthMap[allMonths[0]]);
    }

    loadFutureExpenses();
    setupInfiniteScroll();

    // 年月日セレクトボックス初期化
    const yearSelect = document.getElementById("future-year");
    const monthSelect = document.getElementById("future-month");
    const daySelect = document.getElementById("future-day");
    const currentYear = new Date().getFullYear();
    for (let y = currentYear - 3; y <= currentYear + 5; y++) {
      const opt = document.createElement("option");
      opt.value = y;
      opt.textContent = y;
      yearSelect.appendChild(opt);
    }
    for (let m = 1; m <= 12; m++) {
      const opt = document.createElement("option");
      opt.value = m.toString().padStart(2, "0");
      opt.textContent = m + "月";
      monthSelect.appendChild(opt);
    }
    function updateFutureDays() {
      daySelect.innerHTML = "";
      const year = parseInt(yearSelect.value);
      const month = parseInt(monthSelect.value);
      const daysInMonth = new Date(year, month, 0).getDate();
      for (let d = 1; d <= daysInMonth; d++) {
        const opt = document.createElement("option");
        opt.value = d.toString().padStart(2, "0");
        opt.textContent = d + "日";
        daySelect.appendChild(opt);
      }
    }
    yearSelect.addEventListener("change", updateFutureDays);
    monthSelect.addEventListener("change", updateFutureDays);
    // 初期値は今日
    yearSelect.value = currentYear;
    monthSelect.value = (new Date().getMonth() + 1).toString().padStart(2, "0");
    updateFutureDays();
    daySelect.value = new Date().getDate().toString().padStart(2, "0");

    // フォームとメッセージの要素取得
    const futureForm = document.getElementById("future-form");
    const futureMessage = document.getElementById("future-message");

    if (futureForm) {
      futureForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        const date = yearSelect.value + "-" + monthSelect.value + "-" + daySelect.value;
        const amount = Math.abs(Number(document.getElementById("future-amount").value)) * futureSign;
        const note = document.getElementById("future-note").value;
        const tagsInput = document.getElementById("future-tags").value.trim();
        const tags = tagsInput ? tagsInput.split(/\s+/) : [];
        try {
          await addDoc(collection(db, "future_expenses"), {
            date,
            amount,
            note,
            tags,
            createdAt: new Date()
          });
          futureForm.reset();
          // 日付セレクトもリセット
          yearSelect.value = currentYear;
          monthSelect.value = (new Date().getMonth() + 1).toString().padStart(2, "0");
          updateFutureDays();
          daySelect.value = new Date().getDate().toString().padStart(2, "0");
          futureMessage.textContent = "登録しました！";
          futureMessage.className = "mt-2 text-green-600 text-sm";
          await loadFutureExpenses();
        } catch (err) {
          futureMessage.textContent = "エラー: " + err.message;
          futureMessage.className = "mt-2 text-red-600 text-sm";
        }
      });
    }

    // トグルボタンのロジック
    let futureSign = -1;
    document.getElementById("future-type-minus").addEventListener("click", function() {
      futureSign = -1;
      this.className = "toggle-expense-type bg-red-500 text-white px-3 py-1 rounded font-bold";
      document.getElementById("future-type-plus").className = "toggle-expense-type bg-gray-200 text-gray-700 px-3 py-1 rounded font-bold";
    });
    document.getElementById("future-type-plus").addEventListener("click", function() {
      futureSign = 1;
      this.className = "toggle-expense-type bg-green-500 text-white px-3 py-1 rounded font-bold";
      document.getElementById("future-type-minus").className = "toggle-expense-type bg-gray-200 text-gray-700 px-3 py-1 rounded font-bold";
    });
  </script>
</body>
</html> 